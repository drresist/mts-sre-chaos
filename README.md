# mts-sre-chaos

## Отчет по инженерии хаоса для кластера Патрони

**Дата:** 2023-12-10

**Автор:** Максим Фесенко

**Команда:** МТС SRE course

**Краткое содержание:**

В этом отчете обобщены результаты серии экспериментов по исследованию хаоса, проведенных на кластере Patroni под управлением PostgreSQL. Эксперименты были направлены на проверку устойчивости кластера и возможности его восстановления при различных сценариях сбоев.

**Цели:**

- Оценить процедуру обхода отказа путем принудительного отключения узла.
- Проанализировать влияние частичной потери сети на репликацию и производительность.
- Оценить реакцию систем мониторинга и оповещения на смоделированные сбои.

**Эксперименты:**

**1. Отключение узла:**

- **Описание:** Один узел DB был выключен с помощью MTS cloud hub.
- **Результаты:**
    1. Время восстановления работоспособности: около 1с 
    2. Ниже приведен лог запросов, выполняемых к API - в 20:00:45 заметна задержка в запросе, но ошибок не наблюдается (в момент переключения master ноды)
	```
	[2023-12-10 20:00:42] Success: Response time - 0.062673 seconds
	[2023-12-10 20:00:43] Success: Response time - 0.008084 seconds
	[2023-12-10 20:00:44] Success: Response time - 0.011211 seconds
	[2023-12-10 20:00:45] Success: Response time - 15.007357 seconds
	[2023-12-10 20:01:01] Success: Response time - 0.008497 seconds
	[2023-12-10 20:01:02] Success: Response time - 0.136975 seconds
	[2023-12-10 20:01:03] Success: Response time - 0.119754 seconds
	[2023-12-10 20:01:04] Success: Response time - 0.066597 seconds
	```
	
	```
	Dec 10 20:00:38 db-02 patroni[846]: 2023-12-10 20:00:38,831 INFO: no action. I am (db-02), a secondary, and following a leader (db-01)
	Dec 10 20:00:44 db-02 patroni[846]: 2023-12-10 20:00:44,530 WARNING: Request failed to db-01: GET http://10.0.10.2:8008/patroni (HTTPConnectionPool(host='10.0.10.2', >
	Dec 10 20:00:44 db-02 patroni[846]: 2023-12-10 20:00:44,577 INFO: Software Watchdog activated with 25 second timeout, timing slack 15 seconds
	Dec 10 20:00:44 db-02 patroni[846]: 2023-12-10 20:00:44,626 INFO: promoted self to leader by acquiring session lock
	Dec 10 20:00:44 db-02 patroni[1532]: server promoting
	Dec 10 20:00:44 db-02 patroni[846]: 2023-12-10 20:00:44,633 INFO: Lock owner: db-02; I am db-02
	Dec 10 20:00:44 db-02 patroni[846]: 2023-12-10 20:00:44,729 INFO: updated leader lock during promote
	```

![[Pasted image 20231210214901.png]]

- Потеря одного из узлов кластера PostgreSQL не повлияла на нормальное функционирование веб-приложения. Механизм failover отработал мгновенно благодаря использованию сервиса Patroni для управления СУБД PostgreSQL.
- После восстановления и включения узла PostgreSQL в кластере, система продолжила свою работу в прежнем режиме без сбоев. Не произошло изменений в лидерстве etcd, и мастер PostgreSQL остался прежним, что подчеркивает эффективность механизмов обнаружения сбоев и автоматического восстановления в данной конфигурации.

**2. Моделирование частичной потери сети:**

- **Описание:** С помощью `chaosblade` были смоделированы потеря пакетов на Master / Replica node's
```
sudo ./blade create network drop --source-port 5432 --network-traffic out --timeout 300
```
- **Результаты:**
    - Задержка репликации: Задержка репликации не наблюдается
    - Влияние на производительность: При потере на Replica node - система работает стабильно, но при потере на Master - происходит задержка при ответах. На запросах ниже виден момент восстановления
```
[2023-12-10 22:52:25] Success: Response time - 15.068074 seconds
[2023-12-10 22:52:41] Success: Response time - 15.076032 seconds
[2023-12-10 22:52:57] Success: Response time - 15.067347 seconds
[2023-12-10 22:53:13] Success: Response time - 15.071236 seconds
[2023-12-10 22:53:29] Success: Response time - 15.069894 seconds
[2023-12-10 22:53:45] Success: Response time - 15.069187 seconds
[2023-12-10 22:54:02] Success: Response time - 15.072517 seconds
[2023-12-10 22:54:18] Success: Response time - 4.261715 seconds
[2023-12-10 22:54:23] Success: Response time - 0.155950 seconds
[2023-12-10 22:54:24] Success: Response time - 0.145614 seconds
```

**3. Высокая нагрузка на процессор:**

- **Описание:** Высокая нагрузка на процессор была сгенерирована на Master node psql с помощью `chaosblade`
```
./blade create cpu fullload --timeout 300
```
![[Pasted image 20231210225800.png]]
- **Результаты:**
    - Время ответа сервиса не изменяется, также ошибки не появляются
      ![[Pasted image 20231210230302.png]]
    - При нагрузке на Haproxy также не наблюдается изменений 

**4. Тестирование системы мониторинга и оповещения:**.

- **Описание:** Проверка работы алертов - активность нод и ЦПУ загрузка
- **Результаты:**
	- ![[Pasted image 20231210235042.png]]
	-  ![[Pasted image 20231210234959.png]]
**Общие выводы:**.

- Кластер Patroni продемонстрировал хороший уровень устойчивости и восстановления.
- Для объективного тестирования нужно увеличивать нагрузку на кластер путем 
- Системы мониторинга и оповещения были эффективны в обнаружении и оповещении о сбоях. От момента падения ноды до уведомления около минуты

**Рекомендации:**

- Внедрите изменения для улучшения времени обхода отказа и производительности при сетевых проблемах.
- Продолжать тестирование и мониторинг кластера для выявления и устранения потенциальных уязвимостей.
- Инвестировать в дополнительные инструменты и фреймворки хаос-инженерии для более сложных сценариев тестирования.

